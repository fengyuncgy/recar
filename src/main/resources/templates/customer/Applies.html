<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap.min.css">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/style.min_EDT.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/master.css">
    <link rel="stylesheet" type="text/css" href="css/plugins/iCheck/custom.css">
    <link rel="stylesheet" type="text/css" href="js/plugins/layer/skin/layer.css">
    <script src="js/jquery.min.js"></script>
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <script src="layui/layui.js" charset="utf-8"></script>
    <title>账号设置</title>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>预约信息</h5>

                    <div style="float:right; ">
                        <input id="id" name="id" type="hidden"/>
                        <h5 id="name" style="margin-left: 200px"></h5>
                        <h5 id="sex" style="margin-left: 30px">性别：</h5>
                    </div>
                </div>
                <div class="ibox-content" id="tab-box">
                    <div class="row m-b-lg">
                        <div class="col-sm-12">
                            <button type="button" class="btn btn-primary delete-btn"><i class="fa fa-plus"></i> 删除</button>
                            <button type="button" class="btn btn-primary add-btn"><i class="fa fa-plus"></i> 添加</button>
                            <button type="button" class="btn btn-primary update-btn"><i class="fa fa-plus"></i> 同意</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="ListTB">

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="add" style="display: none;">
    <form action="" class="layui-form form-horizontal">
        <div class="form-box">
            <div class="form-group"><label class="col-sm-3 control-label">名称:</label>
                <div class="col-sm-8 no-padding">
                    <input type="text" lay-verify="title" name="applyName" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">价格:</label>
                <div class="col-sm-8 no-padding">
                    <input type="text" name="applyPrice" value="20"  disabled class="form-control">
                </div>
                '
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">错误信息:</label>
                <div class="col-sm-8 no-padding">
                    <input type="text" name="error" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">选择汽车:</label>
                <div class="col-sm-8 no-padding">
                    <select lay-ignore id="car1" name="carid" class="form-control"></select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">维修时间:</label>
                <div class="col-sm-8 no-padding">
                    <input type="textt" id="date"  name="maintainTime" class="form-control"/>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">付款:</label>
                <div class="col-sm-8 no-padding">
                    <input type="checkbox" lay-ignore  name="applyStatus"/>
                </div>
            </div>
            <div class="col-sm-12 m-t text-center">
                <button class="btn btn-primary " id="BtnSave" lay-submit lay-filter="addApply" type="button"><i
                        class="fa fa-floppy-o"></i> 保存
                </button>
            </div>
        </div>
    </form>
</div>

<script src="js/bootstrap.min.js"></script>
<script src="js/plugins/iCheck/icheck.min.js"></script>
<script src="js/plugins/datapicker/bootstrap-datepicker.js"></script>
<script src="js/plugins/layer/layer.min.js"></script>

<script>
    layui.use('table', function () {
        var table = layui.table;
        var opt = {
            elem: '#ListTB'
            , url: '/apply/getOnes?id='+$('#id').val()
            , cols: [
                [
                    {type: 'checkbox'}
                    , {field: "applyid", width: 40, title: 'ID'}
                    , {field: 'applyName', width: 200, title: '名称'}
                    , {field: 'applyTime', title: '生成时间'}
                    , {field: 'applyPrice', title: '价格'}
                    , {field: 'applyStatus', width: 120, title: '状态'}
                    , {field: 'maintainTime', width: 80, title: '检查时间'}
                    , {field: 'brand', title: '品牌'}
                    , {field: 'name', width: 200, title: '客户'}
                ]
            ]
            , done: function () {
                $("[data-field='applyStatus']").children().each(function () {
                    if ($(this).text() == '1') {
                        $(this).text("已付款")
                    } else if ($(this).text() == '0') {
                        $(this).text("未付款")
                    }else if ($(this).text() == '2'){
                        $(this).text("审核成功")
                    }else if ($(this).text() == '3'){
                        $(this).text("审核失败")
                    }else if ($(this).text() == '4'){
                        $(this).text("用户同意")
                    }
                });

            }

        }
        table.render(opt);

        $('.delete-btn').on('click', function () {
            var checkStatus = table.checkStatus('ListTB')
                , data = checkStatus.data;

            var string = '';
            if(data.length==0){
                layer.msg("删除失败，选择框不能为空", {
                    time: 0
                    , btn: ['确定']
                    , yes: function (index) {
                        layer.close(index);
                    }
                });
            }
            for (var i = 0; i < data.length; i++){
                if (i == data.length - 1) string += data[i].applyid
                else string += data[i].applyid + ','
                if(data[i].applyStatus != 0){
                    layer.msg("删除失败，只能删除未付款的预约", {
                        time: 0
                        , btn: ['确定']
                        , yes: function (index) {
                            layer.close(index);
                            window.location.href = '/customer_Applies'
                        }
                    });
                    return false
                }
            }
            $.ajax({
                type: "get",
                url: "/apply/delete",
                data: {applyid: string},
                contentType: 'application/json;charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    layer.msg(data.message, {
                        time: 0 //不自动关闭
                        , btn: ['确定']
                        , yes: function (index) {
                            layer.close(index);
                            window.location.href = '/customer_Applies'
                        }
                    });

                }
            });

        });
        $('.update-btn').on('click', function () {
            var checkStatus = table.checkStatus('ListTB')
                , data = checkStatus.data;
            if(data.length==0||data.length>1)
                layer.msg("修改失败，选择框不能为空和多选", {
                    time: 0
                    , btn: ['确定']
                    , yes: function (index) {
                        layer.close(index);
                    }
                });
            data=data[0];
            if(!(data.applyStatus==0||data.applyStatus==2)) return false;

            data.applyStatus=data.applyStatus==0?1:data.applyStatus
            data.applyStatus=data.applyStatus==2?4:data.applyStatus

            $.ajax({
                type: "post",
                url: "/apply/updateStatus",
                data:JSON.stringify(data),
                contentType: 'application/json;charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    layer.msg(data.message, {
                        time: 0 //不自动关闭
                        , btn: ['确定']
                        , yes: function (index) {
                            layer.close(index);
                            window.location.href = '/customer_Applies'
                        }
                    });

                }
            });

        });
    });

    layui.use('form', function () {
        var form = layui.form;
        //监听提交
        form.on('submit(addApply)', function (data) {
            data.field.applyStatus =data.field.applyStatus =='on'? 1:0;
            $.ajax({
                type: "POST",
                url: "/apply/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    layer.msg(data.message, {
                        time: 0 //不自动关闭
                        , btn: ['确定']
                        , yes: function (index) {
                            layer.close(index);
                            window.location.href = '/customer_Applies'
                        }
                    });

                }
            });
            return false;
        });
    });

</script>
<script>
    function init() {
        $.get('/login/session', function (data) {
            if (data.data == null) {
                alert("权限不够")
                window.location.href = '/login';
            } else {
                $('#id').val(data.data.customerid)
                $('#name').append("欢迎" + data.data.name)
                $('#sex').append(data.data.sex == 1 ? "男" : "女")
                $.get( '/car/getOnes?id=' + data.data.customerid, function (data){
                    $.each(data.data,function (index,data) {
                       $("#car1").append('<option value="'+data.carid+'">'+data.brand+'</option>>')
                    })
                });
            }
        });
    }

    layui.use(["layer","laydate"],function() {
        var $=layui.jquery,layer=layui.layer,laydate=layui.laydate;
        //新增一个Tab项

        $('.add-btn').on('click', function () {
            layer.open({
                title: '增加',
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                area: ['420px', '440px'],
                shadeClose: true, //点击遮罩关闭
                content: $("#add"),
                success: function(){  //层弹出后的成功回调方法
                    laydate.render({
                        elem:"#date",
                        type:"datetime",
                        min: 0,
                        format:"yyyy-MM-dd HH:mm:ss"
                    })
                }
            });
        });
    });
    $(document).ready(function () {
        init()



    });

</script>
</body>
</html>